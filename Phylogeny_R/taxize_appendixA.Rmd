---
title: "taxize_appendixA"
author: "Xin (David) Zhao"
date: "2023-05-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Appendix A. A complete reproducible workflow, from a species list to a phylogeny, and distribution map 

This markdown R file demonstrates the workflow introduced in the paper, "taxize: taxonomic search and retrieval in R (2013)"

The [website](https://docs.ropensci.org/taxize/articles/infotable.html) provide up-to-date detailed instruction of taxize (version 0.9.100)

### Load the package 
```{r}
# Install the package 
install.packages("taxize")
# install.packages("remotes") 

# Load the library  
# library(taxize) 
# remove.packages("taxize")

library(plyr)
library(remotes) # Enable installing older versions of packages 

# Install taxize (version 0.5.2)
# remotes::install_version("taxize", "< 0.5.2")  
# library(Taxonstand)

# install.packages('~/Downloads/taxize_0.5.2.tar.gz', repos=NULL, type='source') 
library(taxize)


```

### Resolve taxonomy names 

Create a species list. Note that each of the names is spelled incorrectly. 
```{r}

splist_error <- c("Helanthus annuus", 
                  "Pinos contorta",
                  "Collomia grandiflorra",
                  "Rosa california",
                  "Mimulus bicolour",
                  "Nicotiana glauca",
                  "Maddia sativa") 

splist_temp <- taxize::gnr_resolve(splist_error)

head(splist_temp)


# Create a new vector that contains species names without errors 
split_resolved <- c("Helianthus annuus",
                    "Pinus contorta",
                    "Collomia grandiflora",
                    "Rosa californica",
                    "Mimulus bicolor",
                    "Nicotiana glauca",
                    "Madia sativa") 

```
The GNR service provides data from a variety of data sources. The user may trust a specific data source, thus may want to use the names from that data source. 


```{r}
# Retrieve the taxonomic serial number (TSN) in ITIS for a search term 
tsns <- taxize::get_tsn(sci_com = split_resolved,
                        accepted = FALSE)  

# Retrieve accepted TSN and name 
lapply(tsns, taxize::itis_acceptname)
```

```{r}
# Retrieve common names 
comnames <- base::lapply(split_resolved, # scientific (species) names 
                         taxize::sci2comm, # Retrieve common names based on species names
                         db = "itis", 
                         simplify = TRUE) 

# Convert the list to a vector 
comnames_vec <- sapply(comnames, function(x) as.vector(unlist(x))[1])  

# Combine scientific names and common names 
allnames <- data.frame(spname = split_resolved, # sci names 
                       comname = comnames_vec) # common names 

```


### Retrieve higher taxonomic names 

Another task biologists often face is getting higher taxonomic names for a taxa list. 
- Enable users to put into context the relationships of their species list 
- Aggregate/ standardize data to a specific taxonomic level easily 
- Match data to other databases with different taxonomic resolution (e.g., trait databases)

We use data sources, NCBI and ITIS for demonstration below. 

```{r}

# class_list <- taxize::classification(tsns)

# sapply(class_list, nrow) 
# 
# get.theirName <- function(x) {
#     temp <- x[, c("rank", "name")]
#     values <- data.frame(t(temp[, 2])) 
#     names(values) <- temp[, 1]
#     return(values) 
# }
# 
# class_df <- ldply(class_list, get.theirName)
# 
# # Merge taxonomic names at all ranks 
# allnames_df <- merge(allnames, class_df, by.x = "spname", by.y = "species") 
# 
# # View first rows 
# head(allnames_df, 5) 


speciesList <- c("Abies procera", "Pinus contorta") 

# ITIS data source 
taxize::classification(speciesList, db = "itis")

# NCBI data source
taxize::classification(speciesList, db = "ncbi")

# Specify the rank to retrieve from NCBI 
taxize::tax_name("lactobacillus reuteri", get = "family", db = "ncbi")


```


### Get phylogeny via the web service, Phylomatic 

Unfortunately, `phylomatic_tree()` is no longer functional in taxize package. Alternatively, the R package `brranching` has a function `phylomatic()` that implements the same function. 

The [website](https://www.rdocumentation.org/packages/brranching/versions/0.7.0/topics/phylomatic) for brranching provides more detailed information. 

```{r}

# Fetch phylogeny from Phylomatic - phylomatic_tree() refuncts 
# phylogeny <- phylomatic_tree(taxa = as.character(allnames$spname),
#                              taxnames = TRUE,
#                              get = "POST",
#                              informat = "newick",
#                              method = "phylomatic",
#                              storedtree = "R20120829",
#                              taxaformat = "slashpath",
#                              outformat = "newick",
#                              clean = "true",
#                              parallel = TRUE) 

```

### Interactive name selection 

```{r}

sp_interactiveNameSelect <- c("annona cherimola",
                              "annona muricata",
                              "quercus robur") 

get_tsn(sp_interactiveNameSelect, searchtype = "scientific")

```

```{r}
# Select the first row which means there is no interactive component
taxize::get_nbnid("Poa annua", rows = 1)

# Get all data back with functions of the form, e.g. get_tsn_(), and likewise for other data sources
out <- taxize::get_nbnid_("Poa annua")  
nrow(out$"Poa anua") 

```


### Coerce numeric/ alphanumerics to taxon IDs 

Coerce numerics and alphanumerics to taxonomic ID classes that are usually only retrieved via `get_*()` functions. 

```{r}

# Already a uid, returns the same 
taxize::as.gbifid(taxize::get_gbifid("Poa annua"), 
                  check = FALSE) # Runs faster when making check off 


```


### What taxa are downstream of my taxon of interest?

taxize provides an easy way to programmatically search for downstream taxa for the Integrated Taxonomic Information System. 

```{r}

# ID for Apis, fetched beforehand to save time here 
apis_itis_id <- 154395 

# Retrieve children for a given taxon name or ID
taxize::downstream(apis_itis_id, # Vector of taxa names (string) or IDS (string or num)
                   downto = "species", # The taxonomic rank to go down to 
                   db = "itis") # string, database to query  

```
### Direct children 

`taxize` helps get the DIRECT children with methods for ITIS and NCBI. 

```{r, include=FALSE} 

# Retrieve immediate children taxa for a given taxon name or ID 
taxize::children("lactobacillus", # Vector of taxa names (string) or IDs (string or num)
                 db = "ncbi",
                 rows = 10) # Note that this argument is ignored if ID is passed! 

```

### Get NCBI ID from GenBank IDs 

```{r}

# With accession numbers
taxize::genbank2uid(id = "AJ748748") 

# With gi numbers 
taxize::genbank2uid(id = 62689767) 

```

### Match species tables with different taxonomic resolution  

Biologists may want to merge two data tables, say abundance data and trait data. However, those two data tables contain species information on different taxonomic levels and possibly data must be aggregated to a joint taxonomic level, so that the data is merge-able. 

Luckily, `taxize` can help in this data-cleaning step, providing a reproducible workflow:

Use `classification`-function to retrieve the taxonomic hierarchy and then search the hierarchies up- and downwards for matches. 

Here is an example to match a species with names  on three different taxonomic levels. 

```{r}

A <- "gammarus roeseli"

B1 <- "gammarus roeseli" 
B2 <- "gammarus" 
B3 <- "gammaridae" 

A_class <- taxize::classification(A, db = "ncbi") 
B1_class <- taxize::classification(B1, db = "ncbi") 
B2_class <- taxize::classification(B2, db = "ncbi") 
B3_class <- taxize::classification(B3, db = "ncbi")

B1[base::match(A, B1)] 

A_class[[1]]$rank[tolower(A_class[[1]]$name) %in% B2] # A matches B2 on genus level 

A_class[[1]]$rank[tolower(A_class[[1]]$name) %in% B3] # A matches B3 on family level 

```










